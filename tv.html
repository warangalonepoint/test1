<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TV Display Â· Clinic Queue</title>

<!-- Dexie + DB helpers -->
<script defer src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>
<script type="module" defer src="./scripts/db.js"></script>

<style>
/* ===== Pastel Theme (modern, soft) ===== */
:root{
  --bg: #f7fafc;
  --ink: #0f172a;
  --muted:#64748b;
  --mint:#E8F6ED;
  --lav:#F0EAFE;
  --peach:#FFF3E8;
  --teal:#C8F1EC;
  --pink:#F7C1D9;

  /* Banner v8.1 */
  --banner-grad: linear-gradient(135deg, #e8f6ed 0%, #f0eafe 40%, #fff3e8 100%);
  --ring: 0 10px 28px rgba(17,24,39,.12);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  color:var(--ink);
  background: radial-gradient(1200px 600px at 10% -10%, #ffffff 0%, #f7fbff 60%, #f7fafc 100%);
}

/* Layout */
.screen{max-width:1480px; margin:0 auto; padding:18px 18px 24px;}
.header{
  position:sticky; top:0; z-index:10;
  background:var(--banner-grad);
  border:1px solid #00000010;
  border-radius:18px;
  padding:14px 16px;
  box-shadow: var(--ring);
}
.hrow{display:flex; align-items:center; gap:14px}
.brand{display:flex; align-items:center; gap:12px; min-width:280px;}
.brand img{width:46px; height:46px; object-fit:contain; filter:drop-shadow(0 2px 4px rgba(0,0,0,.08))}
.brand .title{font-weight:800; font-size:20px}
.brand .sub{font-size:12px; color:#334155}
.hsp{flex:1}
.hbtns{display:flex; align-items:center; gap:8px}
.btn{border:none; background:#ffffffcc; color:#0f172a; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:700; backdrop-filter: blur(4px);}
.btn:hover{background:#fff}
.clock{font-variant-numeric:tabular-nums; color:#0f172a; background:#ffffffb8; padding:6px 10px; border-radius:10px}

.notice{ margin-top:10px; font-size:13px; color:#334155; display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
.badge{ display:inline-flex; align-items:center; gap:6px; border:1px dashed #00000022; background:#fff; padding:4px 10px; border-radius:999px; font-size:12px;}

/* Sections */
.section{ margin-top:18px }
.section h2{ margin:0 0 10px; font-weight:800; letter-spacing:.2px; font-size:22px; color:#0f172a; }

/* Now Serving */
.grid-now{ display:grid; gap:14px; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); }
.tile{
  position:relative; border-radius:18px; padding:20px;
  background: conic-gradient(from 180deg at 50% 50%, var(--mint), var(--lav), var(--peach), var(--teal), var(--pink), var(--mint));
  background-size: 200% 200%; animation: swirl 16s linear infinite; box-shadow: var(--ring); overflow:hidden;
}
.tile::after{ content:""; position:absolute; inset:0; border-radius:18px; background: linear-gradient(180deg, #ffffff60, #ffffff00); pointer-events:none; }
@keyframes swirl{ 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
.token{font-size:56px; font-weight:900; line-height:1; color:#0f172a; text-align:center}
.pname{margin-top:6px; text-align:center; font-size:18px; color:#0f172a}
.meta{margin-top:2px; text-align:center; font-size:12px; color:#334155}

/* Up Next (Queued/Waiting only) */
.card{ background:#ffffff; border:1px solid #00000010; border-radius:18px; box-shadow: var(--ring); padding:0; overflow:hidden; height:420px; position:relative; }
.table{width:100%; border-collapse:collapse; font-size:18px}
.table th, .table td{padding:12px 14px; border-bottom:1px dashed #e2e8f0}
.table thead th{position:sticky; top:0; background:#f8fafc; z-index:1; font-size:14px; text-transform:uppercase; letter-spacing:.5px; color:#334155}
.scroll{ position:absolute; inset:44px 0 0 0; overflow:hidden }
.scroller{ will-change:transform }
@keyframes scrollUp{ from{transform:translateY(0)} to{transform:translateY(-50%)} }

/* Footer + Empty */
.footer{ margin-top:16px; text-align:center; color:#64748b; font-size:12px }
.empty{ padding:16px; text-align:center; color:#64748b; font-size:16px; background: linear-gradient(0deg, #ffffff, #ffffffcc); }

@media (max-width: 640px){
  .brand .title{font-size:18px}
  .token{font-size:44px}
}
</style>
</head>
<body>
<div class="screen">

  <!-- Banner (v8.1 style) -->
  <div class="header">
    <div class="hrow">
      <div class="brand">
        <img src="./assets/logo.png" alt="logo" onerror="this.style.display='none'">
        <div>
          <div class="title" id="clinicTitle">Clinic TV Queue</div>
          <div class="sub" id="clinicLine">Welcome</div>
        </div>
      </div>

      <div class="hsp"></div>

      <div class="hbtns">
        <span id="clock" class="clock">--:--</span>
        <button id="togglePriv" class="btn">ðŸ«£ Privacy</button>
        <button id="full" class="btn">â›¶ Fullscreen</button>
      </div>
    </div>

    <div class="notice">
      <span class="badge" id="todayInfo">â€”</span>
      <span class="badge" id="counts">Now: 0 Â· Queue: 0</span>
      <span class="badge">Now: serving / in-progress Â· Up Next: queued / waiting</span>
    </div>
  </div>

  <!-- Now Serving -->
  <div class="section">
    <h2>Now Serving</h2>
    <div id="nowWrap" class="grid-now">
      <div class="empty">No active patients</div>
    </div>
  </div>

  <!-- Up Next (Queued/Waiting only) -->
  <div class="section">
    <h2>Up Next</h2>
    <div class="card" id="nextCard">
      <table class="table">
        <thead>
          <tr><th style="width:120px">Token</th><th>Patient</th><th style="width:180px">Type</th></tr>
        </thead>
      </table>
      <div class="scroll" id="upNext">
        <div class="empty">No upcoming patients</div>
      </div>
    </div>
  </div>

  <div class="footer">Powered by Onestop AI Services Â· Â© 2025 Â· All Rights Reserved</div>
</div>

<script>
/* Config banner (doctor-config) */
(async function loadConfig(){
  try{
    const r=await fetch('./config/doctor-config.json',{cache:'no-store'});
    if(r.ok){
      const c=await r.json();
      const title = c.clinicName || c.doctorName || 'Clinic TV Queue';
      const line  = [c.doctorName, c.degrees, c.addressLine1, c.phone].filter(Boolean).join(' Â· ');
      document.getElementById('clinicTitle').textContent = title;
      document.getElementById('clinicLine').textContent  = line || 'Welcome';
    }
  }catch{}
})();

/* Clock */
(function tick(){
  const el=document.getElementById('clock');
  if(el) el.textContent=new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  setTimeout(tick, 1000);
})();

/* Privacy + fullscreen */
let privacy=true;
document.getElementById('togglePriv').onclick=()=>{ privacy=!privacy; render(dataCache); };
document.getElementById('full').onclick=()=>{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); } else { document.exitFullscreen(); } };
const maskName=n=>(!n?'': (privacy? (n[0]?.toUpperCase()||'')+'***' : n));

/* DB helpers */
let db=null;
(async function ensureDB(){
  try{
    if(!window.DB){
      db=new Dexie('clinicdb');
      db.version(1).stores({bookings:'++id,date,ts,pid,token,status,patientName,type,contact'});
      await db.open();
    }
  }catch(e){ console.warn('Dexie open failed', e); }
})();
function todayISO(){ return new Date().toISOString().slice(0,10); }
async function listTodayBookings(){
  try{
    if(window.DB?.listBookingsToday){ return await DB.listBookingsToday(); }
    if(db){ return await db.table('bookings').where('date').equals(todayISO()).toArray(); }
  }catch(e){ console.warn('listTodayBookings failed', e); }
  return [];
}

/* Status buckets */
const NOW_STATUSES   = new Set(['checked-in','in-progress','serving','called']);
/* Per your requirement: show only queued / waiting as active queue */
const QUEUE_STATUSES = new Set(['queued','waiting']);
const DONE_STATUSES  = new Set(['completed','done','no-show','cancelled','served']);

/* Refresh + render */
let dataCache={now:[], upcoming:[]};

async function refresh(){
  const all=(await listTodayBookings())||[];
  document.getElementById('todayInfo').textContent = new Date().toLocaleDateString();

  all.forEach(r=>{
    r.status=(r.status||'').toLowerCase();
    r.token=r.token ?? 'â€”';
    r.name = r.patientName || r.name || '';
  });

  const now = all
    .filter(r=> NOW_STATUSES.has(r.status))
    .sort((a,b)=>(b.ts||0)-(a.ts||0));

  const upcoming = all
    .filter(r=> QUEUE_STATUSES.has(r.status) && !DONE_STATUSES.has(r.status))
    .sort((a,b)=>(a.ts||0)-(b.ts||0) || String(a.token).localeCompare(String(b.token)));

  dataCache={now,upcoming};
  render(dataCache);
}
setInterval(refresh, 6000);
window.addEventListener('DOMContentLoaded', refresh);

/* Live sync listeners */
const QUEUE_CH='clinic-queue-sync-v1';
// BroadcastChannel
try{
  const bc = new BroadcastChannel(QUEUE_CH);
  bc.onmessage = (ev)=>{ if(ev?.data?.type==='queue-update') refresh(); };
}catch{}
// localStorage fallback
window.addEventListener('storage', (e)=>{ if(e.key==='queue_touch') refresh(); });

/* Render */
function render({now,upcoming}){
  document.getElementById('counts').textContent = `Now: ${now.length} Â· Queue: ${upcoming.length}`;

  // Now Serving
  const nw=document.getElementById('nowWrap');
  if(!now.length){
    nw.innerHTML='<div class="empty">No active patients</div>';
  }else{
    nw.innerHTML = now.map(r=>`
      <div class="tile">
        <div class="token">${r.token}</div>
        <div class="pname">${maskName(r.name)}</div>
        <div class="meta">${(r.type||'').toUpperCase()}</div>
      </div>
    `).join('');
  }

  // Up Next (queued/waiting)
  const box=document.getElementById('upNext');
  if(!upcoming.length){
    box.innerHTML='<div class="empty">No upcoming patients</div>';
    return;
  }
  const row = r => `<tr>
    <td style="width:120px; font-weight:800">${r.token}</td>
    <td>${maskName(r.name)}</td>
    <td style="width:180px; color:var(--muted)">${(r.type||'').toUpperCase()}</td>
  </tr>`;
  const rows = upcoming.map(row).join('');
  const table = `<table class="table"><tbody>${rows}${rows}</tbody></table>`;
  box.innerHTML = `<div id="scroller" class="scroller">${table}</div>`;

  const dur = Math.max(18, Math.round(upcoming.length * 2.2));
  const sc = document.getElementById('scroller');
  sc.style.animation = `scrollUp ${dur}s linear infinite`;
}
</script>
</body>
</html>