<!doctype html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.webmanifest"/>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Print · Lab Report</title>
<style>
@page{size:A4;margin:12mm}
*{box-sizing:border-box}
body{margin:0;font:13px/1.45 system-ui;color:#0f172a;background:#fff}
.wrap{max-width:800px;margin:0 auto;padding:12mm}
.hdr{display:flex;align-items:center;gap:12px;border-bottom:2px solid #0f172a20;padding-bottom:8px}
.hdr .logo{height:52px}
.hdr .t{font-weight:900;font-size:20px}
.hdr .sub{font-size:12px;color:#475569}

/* Banner */
.banner{margin:6px 0 10px;border-radius:12px;overflow:hidden;border:1px solid #e5e7eb;max-height:120px}
.banner img{width:100%;height:auto;object-fit:contain;transform:scale(.55);
  transform-origin:center;opacity:.92;mix-blend-mode:multiply;display:block}

.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.box{flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
.labtab{width:100%;border-collapse:collapse;margin-top:10px}
.labtab th,.labtab td{border:1px solid #94a3b8;padding:6px;text-align:left}
.labtab th{background:#f1f5f9}
.sign{margin-top:18px;display:flex;justify-content:space-between;align-items:flex-end}
.small{font-size:12px;color:#64748b}
.qr{width:90px;height:90px;border:1px dashed #cbd5e1;border-radius:8px;display:flex;align-items:center;justify-content:center}
.total-line{margin-top:12px;text-align:right;font-weight:800;font-size:14px}
.footerline{
  text-align:center;font-size:11px;color:#0f172a;margin-top:14px;
  border-top:2px solid #facc15;padding-top:4px;font-weight:500;
}
</style>
<script src="/config/config.js"></script>
<script src="/scripts/app-wiring.js"></script>
<script src="/scripts/db.js"></script>
</head>
<body>
<div class="wrap" id="root">
  <div class="hdr">
    <img class="logo" src="../assets/logo.png" onerror="this.style.display='none'">
    <div>
      <div class="t" id="labTitle">Charan Clinical Laboratory</div>
      <div class="sub" id="labSub">Quality Diagnostics · Same-day Reports</div>
    </div>
  </div>

  <!-- Banner (fixed relative path) -->
  <div class="banner"><img src="../assets/banner/banner.png" alt="Clinic Banner"></div>

  <div class="row">
    <div class="box"><b>Pt Name:</b> <span id="pname">—</span></div>
    <div class="box" style="flex:0 0 140px"><b>Sex:</b> <span id="psex">—</span></div>
    <div class="box" style="flex:0 0 160px"><b>Age:</b> <span id="page">—</span></div>
  </div>
  <div class="row">
    <div class="box"><b>Ref By:</b> <span id="pref">—</span></div>
    <div class="box" style="flex:0 0 220px"><b>Date:</b> <span id="pdate">—</span></div>
  </div>

  <!-- Results (no price column) -->
  <table class="labtab">
    <thead>
      <tr>
        <th style="width:45%">Parameters</th>
        <th style="width:25%">Results</th>
        <th>Normal Value</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <!-- Single overall price -->
  <div id="totalLine" class="total-line"></div>

  <div class="sign">
    <div class="small">LAB TECHNICIAN</div>
    <div id="qrBox" class="qr"><div id="qr"></div></div>
  </div>

  <div class="small" style="text-align:center;margin-top:8px">Powered by Onestop AI Services</div>

  <div class="footerline">
    H.No. 2-1-45, Sarswathi Nagar, Opp. Andhra Bank ATM, Gopalapuram, Hanmakonda, Telangana-506001 ·
    <strong>Ph: +91-8340840340</strong>
  </div>
</div>

<script src="/scripts/qrcode.min.js"></script>
<script>
const Q = s=>document.querySelector(s);
function getData(){
  try{
    const u=new URL(location.href);
    const j=u.searchParams.get('data');
    if(j) return JSON.parse(decodeURIComponent(j));
  }catch{}
  try{ return JSON.parse(localStorage.getItem('last_lab_report')||'null') }catch{ return null; }
}
const d=getData()||{};
Q('#pname').textContent = d.name || d.patient || '—';
Q('#psex').textContent  = d.sex || '—';
Q('#page').textContent  = d.age ? (d.age+' Y') : '—';
Q('#pref').textContent  = d.ref || '—';
Q('#pdate').textContent = d.date || new Date().toISOString().slice(0,10);

/* Render parameters */
const tb=document.getElementById('tbody');
if(Array.isArray(d.items)){
  d.items.forEach(x=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${x.lab||x.test||''}</td>
                    <td>${x.result||''}</td>
                    <td>${x.norm||''}</td>`;
    tb.appendChild(tr);
  });
}

/* Overall test price (sum of item prices if present, else d.total) */
let total = 0;
if (Array.isArray(d.items)) total = d.items.reduce((s,x)=>s + (+x.price||0), 0);
if (!total && d.total) total = +d.total || 0;
Q('#totalLine').textContent = total ? `Total: ₹ ${total.toFixed(0)}` : '';

/* QR with summary */
(function makeQR(){
  const payload = {
    pid: d.pid || '',
    name: d.name || '',
    date: Q('#pdate').textContent,
    total,
    sig: 'LABREP'
  };
  try{
    new QRCode(document.getElementById('qr'),{
      text: JSON.stringify(payload),
      width: 88, height: 88,
      correctLevel: QRCode.CorrectLevel.M
    });
  }catch(e){ document.getElementById('qrBox').style.display='none'; }
})();

/* auto-print mode */
if (new URL(location.href).searchParams.get('print')==='1'){
  setTimeout(()=>window.print(), 200);
}
</script>
</body>
</html>