<!doctype html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.webmanifest"/>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OPD Summary ¬∑ Print</title>

<style>
:root{
  --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --bg:#ffffff; --accent:#E86D2D;
}

*{box-sizing:border-box}
html,body{background:#f3f6fb;color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.wrap{max-width:1000px;margin:0 auto;padding:12px}

/* helper cards (visible only on screen) */
.card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:14px;margin-top:12px}
.row{display:flex;flex-wrap:wrap;gap:10px}
.input,textarea{width:100%;border:1px solid #cbd5e1;border-radius:10px;padding:8px 10px;font:inherit}
.btn{border:1px solid #cbd5e1;background:#fff;border-radius:999px;padding:8px 14px;font-weight:700;cursor:pointer}
small.muted{color:var(--muted)}
hr.sep{border:none;border-top:1px solid var(--line);margin:10px 0}

/* A4 sheet */
.sheet{position:relative;background:var(--bg);color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:18px;overflow:hidden}
.a4{width:210mm;min-height:297mm;margin:auto}
.sheet::before{
  content:""; position:absolute; inset:0; opacity:.06; pointer-events:none;
  background-repeat:no-repeat; background-position:center; background-size:60%;
  filter:grayscale(100%);
}

/* header */
.head{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center}
.logo{height:56px}
.rx{font-weight:900;font-size:40px;color:#1f2937;text-align:right}
.clinic{font-weight:900;font-size:22px;color:#a12c2c;text-align:center}
.telugu{font-weight:800;color:#1a1a1a;font-size:14px}
.qual{font-size:12px;color:#1f2937}
.timing{margin:10px 0;background:var(--accent);color:#fff;padding:8px;border-radius:8px;text-align:center;font-weight:800}

/* info blocks */
.grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
.kv{background:#fafafa;border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:13px}
.kv .k{font-weight:700}

/* vitals: 8 columns (BP & Token removed) */
.vitals{display:grid;grid-template-columns:repeat(8,minmax(0,1fr));gap:6px;margin-top:6px}
.vitals .cell{background:#fafafa;border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:13px}
.vitals .k{font-weight:700}

.sec{margin-top:10px}
.sec h3{margin:8px 0 6px;font-size:15px;text-transform:uppercase;letter-spacing:.3px}
.box{background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px}

.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{border:1px solid #3332;padding:6px;vertical-align:top}
.table th{background:#f3f4f6}

/* small chips for vax */
.pill{display:inline-block;padding:4px 8px;border:1px solid #e2e8f0;border-radius:999px;background:#f8fafc;font-size:12px;margin:2px 6px 0 0}

/* signature + note */
.sig{display:flex;justify-content:flex-end;margin-top:14px}
.sig .line{width:240px;border-top:1px solid #0008;text-align:center;font-size:12px;padding-top:4px}
.note{margin-top:6px;text-align:center;font-size:12px;font-weight:700;color:#1f2937}

.footer{margin-top:8px;text-align:center;font-size:12px;color:#222}
.ribbon{margin-top:8px;background:#4b5563;color:#fff;padding:8px 12px;border-radius:8px;text-align:center;font-weight:800}

/* emergency row (image removed, text kept) */
.emg{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:12px}
.emg .badge{font-weight:800;color:#0b4da2}

/* print */
@media print{
  body{background:#fff} .tools{display:none!important}
  .sheet{box-shadow:none;border:none;padding:10mm} .a4{margin:0}
}
</style>
<style id="wmStyle"></style>
<script src="/config/config.js"></script>
<script src="/scripts/app-wiring.js"></script>
<script src="/scripts/db.js"></script>
</head>
<body>
<div class="wrap">

  <!-- Tools (screen only) -->
  <div class="card tools">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <div><b>Print OPD</b> <small class="muted">Auto-load last OPD, load by PID, or paste JSON</small></div>
      <div class="row">
        <button class="btn" id="btnLoadAuto">Auto: Last Saved</button>
        <div class="row" style="align-items:end">
          <div>
            <label class="label">PID</label>
            <input id="pid" class="input" placeholder="P00001"/>
          </div>
          <button class="btn" id="btnLoadPID">Load by PID</button>
        </div>
        <button class="btn" id="btnPrint">üñ®Ô∏è Print</button>
      </div>
    </div>
    <hr class="sep">
    <div class="row">
      <div style="flex:1 1 100%">
        <label class="label">Paste OPD JSON (optional)</label>
        <textarea id="paste" class="input" style="min-height:140px" placeholder='{"pid":"P0001","name":"..."}'></textarea>
      </div>
    </div>
    <div id="msg" style="margin-top:6px;color:#065f46;display:none"></div>
  </div>

  <!-- A4 OPD Sheet -->
  <div class="card sheet a4" id="sheet">
    <div class="head">
      <div>
        <div class="telugu" id="cfg_telugu">‡∞°‡∞æ|| ‡∞ö‡∞∞‡∞£‡±ç ‡∞•‡±á‡∞ú‡∞æ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞ó‡±Å‡∞∞‡∞ø‡∞ú‡∞æ‡∞≤</div>
        <div class="qual" id="cfg_qual">MBBS, DNB (Paediatrics), MNAMS, PGPN (Boston)</div>
        <div class="qual" id="cfg_spec">Consultant Paediatrician &amp; Neonatologist</div>
        <div class="qual" id="cfg_reg">Reg. No. 74740</div>
      </div>
      <div style="text-align:center">
        <img id="cfg_logo" class="logo" src="./assets/logo.png" alt="Logo"/>
        <div class="clinic" id="cfg_clinic">DR. CHARAN CHILD CLINIC</div>
      </div>
      <div><div class="rx">‚Ñû</div></div>
    </div>

    <div class="timing" id="cfg_time">TIMINGS: MON‚ÄìSAT 9:00 AM ‚Äì 12:00 PM | 6:00 PM ‚Äì 9:00 PM | SUNDAY 10:00 AM ‚Äì 2:00 PM</div>

    <div class="grid4">
      <div class="kv"><div class="k">UHID</div><div id="v_uhid">‚Äî</div></div>
      <div class="kv"><div class="k">Visit No</div><div id="v_visitno">‚Äî</div></div>
      <div class="kv"><div class="k">Patient</div><div id="v_name">‚Äî</div></div>
      <div class="kv"><div class="k">Visit Date</div><div id="v_date">‚Äî</div></div>
      <div class="kv"><div class="k">DOB / Age / Sex</div><div id="v_age">‚Äî</div></div>
      <div class="kv"><div class="k">Consultation</div><div id="v_consult">‚Äî</div></div>
      <div class="kv"><div class="k">Doctor</div><div id="v_doc">Dr. Charan Theja Reddy Gurijala</div></div>
      <div class="kv"><div class="k">Next Visit</div><div id="v_next">‚Äî</div></div>
    </div>

    <!-- Vitals (token & BP removed) -->
    <div class="vitals">
      <div class="cell"><span class="k">Ht</span>: <span id="v_ht">‚Äî</span></div>
      <div class="cell"><span class="k">Wt</span>: <span id="v_wt">‚Äî</span></div>
      <div class="cell"><span class="k">BSA</span>: <span id="v_bsa">‚Äî</span></div>
      <div class="cell"><span class="k">BMI</span>: <span id="v_bmi">‚Äî</span></div>
      <div class="cell"><span class="k">Temp</span>: <span id="v_temp">‚Äî</span></div>
      <div class="cell"><span class="k">Pulse</span>: <span id="v_pulse">‚Äî</span></div>
      <div class="cell"><span class="k">SPO‚ÇÇ</span>: <span id="v_spo2">‚Äî</span></div>
      <div class="cell"><span class="k">Phone</span>: <span id="v_phone">‚Äî</span></div>
    </div>

    <div class="sec"><h3>Chief Complaints</h3><div id="s_cc" class="box">‚Äî</div></div>
    <div class="sec"><h3>Examination</h3><div id="s_exam" class="box">‚Äî</div></div>
    <div class="sec"><h3>Diagnosis</h3><div id="s_dx" class="box">‚Äî</div></div>

    <!-- NEW: Recommended Vaccination -->
    <div class="sec" id="vax_block">
      <h3>Recommended Vaccination</h3>
      <div id="vax_text" class="box">
        <div><b>Age:</b> <span id="ageMonths">‚Äî</span> months</div>
        <div id="vaxDue" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="sec">
      <h3>Medications</h3>
      <table class="table" id="tbl_rx">
        <thead><tr><th>#</th><th>Medicine</th><th>Dosage</th><th>Frequency</th><th>Duration</th><th>Qty</th><th>Remarks</th></tr></thead>
        <tbody></tbody>
      </table>
      <small class="muted">* Take medicines exactly as prescribed.</small>
    </div>

    <div class="sec" id="lab_block" style="display:none">
      <h3>Laboratory Orders</h3>
      <table class="table" id="tbl_lab">
        <thead><tr><th>#</th><th>Test</th><th>Notes</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="sec"><h3>Doctor Recommendations</h3><div id="s_plan" class="box">‚Äî</div></div>

    <div class="sig">
      <div>
        <div class="line">( <span id="sig_dname">Dr. Charan Theja Reddy Gurijala</span> )</div>
        <div class="note" id="consult_valid_note"></div>
      </div>
    </div>

    <!-- Emergency (text only) -->
    <div class="emg">
      <div><span class="badge">For Emergencies:</span> Dolphin Children‚Äôs Hospital, Opp. Kasam Brothers Lane, Beside Police Station, Hanamkonda Chowrastha, Warangal ‚Äî Ph: <b>6309172007 / 6309173007</b></div>
    </div>

    <div class="ribbon" id="cfg_appoint">For Appointment: +91 83408 40340</div>
    <div class="footer" id="cfg_footer">H.No. 2-1-45, Saraswathi Nagar, Gopalapuram, Hanamkonda, Telangana ‚Äì 506 001.</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/dexie@4.0.8/dist/dexie.min.js"></script>
<script>
/* ---------- Config ---------- */
const CFG_KEY='doctor_config_json';
const defaults={
  clinic:"DR. CHARAN CHILD CLINIC",
  doctor_name:"Dr. Charan Theja Reddy Gurijala",
  telugu_line:"‡∞°‡∞æ|| ‡∞ö‡∞∞‡∞£‡±ç ‡∞§‡±á‡∞ú ‡∞∞‡±Ü‡∞°‡±ç‡∞°‡∞ø ‡∞ó‡±Å‡∞∞‡∞ø‡∞ú‡∞æ‡∞≤",
  qualification:"MBBS, DNB (Paediatrics), MNAMS, PGPN (Boston)",
  specialization:"Consultant Paediatrician & Neonatologist",
  reg_no:"74740",
  timings:"TIMINGS: MON‚ÄìSAT 9:00 AM ‚Äì 12:00 PM | 6:00 PM ‚Äì 9:00 PM | SUNDAY 10:00 AM ‚Äì 2:00 PM",
  logo:"./assets/logo.png",
  address:"H.No. 2-1-45, Saraswathi Nagar, Gopalapuram, Hanamkonda, Telangana ‚Äì 506 001.",
  appointment:"+91 83408 40340"
};
const $=s=>document.querySelector(s);
function toast(t){const m=$("#msg");m.textContent=t;m.style.display='block';setTimeout(()=>m.style.display='none',1500);}
function loadCfg(){try{return {...defaults,...(JSON.parse(localStorage.getItem(CFG_KEY)||'{}'))};}catch{return {...defaults};}}
function applyWatermark(url){document.getElementById('wmStyle').textContent=`.sheet::before{background-image:url("${url}")}`;}
function applyCfg(c){
  $('#cfg_telugu').textContent=c.telugu_line;
  $('#cfg_qual').textContent=c.qualification;
  $('#cfg_spec').textContent=c.specialization;
  $('#cfg_reg').textContent="Reg. No. "+c.reg_no;
  $('#cfg_logo').src=c.logo||defaults.logo;
  $('#cfg_clinic').textContent=c.clinic;
  $('#cfg_time').textContent=c.timings;
  $('#cfg_footer').textContent=c.address;
  $('#cfg_appoint').textContent="For Appointment: "+c.appointment;
  $('#sig_dname').textContent=c.doctor_name;
  $('#v_doc').textContent=c.doctor_name;
  applyWatermark(c.logo||defaults.logo);
}

/* ---------- Helpers ---------- */
function addDays(date,days){const d=new Date(date);d.setDate(d.getDate()+days);return d;}
function formatDate(dt){ return dt.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}); }
function parseAgeToMonths(ageStr){ if(!ageStr) return null; const y=(ageStr.match(/(\d+)\s*y/i)||[])[1]||0; const m=(ageStr.match(/(\d+)\s*m/i)||[])[1]||0; return (+y)*12+(+m); }
function dueVaccines(ageM){
  if(ageM==null) return [];
  const plan=[
    {at:0,items:["BCG","OPV-0","HepB-0"]},
    {at:6,items:["DTaP-1","IPV-1","HepB-1","Hib-1","PCV-1","Rotavirus-1"]},
    {at:10,items:["DTaP-2","IPV-2","Hib-2","PCV-2","Rotavirus-2"]},
    {at:14,items:["DTaP-3","IPV-3","Hib-3","PCV-3"]},
    {at:9,items:["MR/Measles-1"]},
    {at:12,items:["HepA-1","Typhoid Conjugate"]},
    {at:15,items:["MMR-2","Varicella-1","PCV Booster"]},
    {at:18,items:["DTaP Booster-1","IPV Booster-1","Hib Booster"]},
    {at:48,items:["DTaP Booster-2","MMR-3","Varicella-2"]},
    {at:60,items:["Typhoid Booster","DT Booster"]}
  ];
  const i=plan.findIndex(p=>ageM<=p.at);
  return (i<0? plan[plan.length-1].items : plan[i].items);
}

/* ---------- Data access (hardened) ---------- */
async function dexieOpen(){
  const db = new Dexie('clinicdb');

  // legacy stores
  db.version(1).stores({
    patients: 'pid,patientName,contact,dob',
    bookings: '++id,date,ts,pid,token'
  });

  // ensure OPD exists (upgrade path)
  db.version(2).stores({
    opd: '++id,ts,pid,date'
  });

  // consolidated schema (future-proof)
  db.version(3).stores({
    patients: 'pid,patientName,contact,dob',
    bookings: '++id,date,ts,pid,token',
    opd: '++id,ts,pid,date'
  });

  try { await db.open(); } catch(e) { console.warn('Dexie open failed:', e); }
  return db;
}

function renderOPD(rec){
  if(!rec) return;
  $('#v_uhid').textContent=rec.pid||'‚Äî';
  $('#v_visitno').textContent=rec.refToken||'‚Äî';
  $('#v_name').textContent=rec.name||'‚Äî';

  const visitDate = rec.ts ? new Date(rec.ts) : (rec.date ? new Date(rec.date) : new Date());
  $('#v_date').textContent=visitDate.toLocaleString();

  // validity note
  const validTill = formatDate(addDays(visitDate,7));
  $('#consult_valid_note').textContent = "CONSULTATION VALID UPTO " + validTill + " WITH ONE REVIEW";

  $('#v_age').textContent=`${rec.age||'-'} / ${rec.gender||'-'}`;
  $('#v_consult').textContent=rec.visitType||'First / Follow-up';
  $('#v_phone').textContent=rec.phone||'‚Äî';
  $('#v_next').textContent=rec.nextVisit||'‚Äî';

  const v=rec.vitals||{};
  $('#v_ht').textContent=v.height||'‚Äî';
  $('#v_wt').textContent=v.weight||'‚Äî';
  $('#v_bsa').textContent=v.bsa||'‚Äî';
  $('#v_bmi').textContent=v.bmi||'‚Äî';
  $('#v_temp').textContent=v.temp||'‚Äî';
  $('#v_pulse').textContent=v.pulse||'‚Äî';
  $('#v_spo2').textContent=v.spo2||'‚Äî';

  $('#s_cc').textContent=(rec.notes?.cc||'').trim()||'‚Äî';
  $('#s_exam').textContent=(rec.notes?.exam||'').trim()||'‚Äî';
  $('#s_dx').textContent=(rec.notes?.dx||'').trim()||'‚Äî';
  $('#s_plan').textContent=(rec.notes?.plan||'').trim()||'‚Äî';

  // Recommended Vaccination render
  const ageM = parseAgeToMonths(rec.age||'');
  $('#ageMonths').textContent = (ageM==null? '‚Äî' : ageM);
  const due = dueVaccines(ageM);
  $('#vaxDue').innerHTML = due.length ? due.map(v=>`<span class="pill">${v}</span>`).join(' ') : '<span class="muted">‚Äî</span>';

  // Rx
  const rx=Array.isArray(rec.rx)?rec.rx:[];
  const rtbody=$("#tbl_rx tbody"); rtbody.innerHTML='';
  rx.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.name||''}</td><td>${r.dose||''}</td><td>${r.freq||''}</td><td>${r.days||''}</td><td>${r.qty||''}</td><td>${r.remark||''}</td>`;
    rtbody.appendChild(tr);
  });

  // Labs
  const labs=Array.isArray(rec.labs)?rec.labs:[];
  const ltbody=$("#tbl_lab tbody"); ltbody.innerHTML='';
  if(labs.length){
    $('#lab_block').style.display='block';
    labs.forEach((t,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${t.test||t.name||''}</td><td>${t.note||''}</td>`;
      ltbody.appendChild(tr);
    });
  }else{
    $('#lab_block').style.display='none';
  }
}

/* ---------- Loaders (hardened with fallbacks) ---------- */
async function loadAuto(){
  // Staged payload (from OPD Live "Print")
  try{
    const staged=JSON.parse(localStorage.getItem('opd_print_payload')||'null');
    if(staged){ renderOPD(staged); return; }
  }catch{}

  // IndexedDB (latest)
  try{
    const db=await dexieOpen();
    if (db.tables.find(t => t.name === 'opd')) {
      const all=await db.table('opd').toArray();
      all.sort((a,b)=>(b.ts||0)-(a.ts||0));
      if(all[0]) { renderOPD(all[0]); return; }
    }
  }catch(e){ console.warn('Dexie loadAuto failed:', e); }

  // LocalStorage fallback
  try{
    const ls = JSON.parse(localStorage.getItem('opd_local_json') || '[]');
    if (ls.length){ ls.sort((a,b)=>(b.ts||0)-(a.ts||0)); renderOPD(ls[0]); return; }
  }catch{}

  console.info('No OPD data found for auto-load.');
}

async function loadByPID(){
  const pid=($('#pid').value||'').trim().toUpperCase();
  if(!pid) return;

  // IndexedDB search
  try{
    const db=await dexieOpen();
    if (db.tables.find(t => t.name === 'opd')) {
      const rows=await db.table('opd').where('pid').equals(pid).toArray();
      rows.sort((a,b)=>(b.ts||0)-(a.ts||0));
      if(rows[0]) { renderOPD(rows[0]); return; }
    }
  }catch(e){ console.warn('Dexie loadByPID failed:', e); }

  // LocalStorage fallback
  try{
    const ls = JSON.parse(localStorage.getItem('opd_local_json') || '[]');
    const rows = ls.filter(r => (r.pid||'').toUpperCase() === pid);
    rows.sort((a,b)=>(b.ts||0)-(a.ts||0));
    if(rows[0]) { renderOPD(rows[0]); return; }
  }catch{}

  // Staged payload (only works if it matches)
  try{
    const staged=JSON.parse(localStorage.getItem('opd_print_payload')||'null');
    if(staged && (staged.pid||'').toUpperCase()===pid){ renderOPD(staged); return; }
  }catch{}

  alert('No OPD record found for '+pid);
}

/* ---------- Wire UI ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  const cfg=loadCfg(); applyCfg(cfg);

  const pidParam=new URL(location.href).searchParams.get('pid');
  if(pidParam){ $('#pid').value=pidParam; await loadByPID(); } else { await loadAuto(); }

  $('#btnLoadAuto').onclick=loadAuto;
  $('#btnLoadPID').onclick=loadByPID;
  $('#paste').addEventListener('change', function(){
    try{ const obj=JSON.parse($('#paste').value||''); renderOPD(obj); toast('Loaded from pasted JSON'); }catch{ toast('Invalid JSON'); }
  });
  $('#btnPrint').onclick=()=>window.print();
});
</script>
</body>
</html>