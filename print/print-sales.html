<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Print Sales Bill · A5</title>
<style>
@page { size: A5 portrait; margin: 6mm; }
*{box-sizing:border-box}
body{margin:0;font:13px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;color:#000}
.wrap{max-width:148mm;margin:0 auto;padding:6mm}
.hdr{display:flex;gap:10px;align-items:center;border-bottom:1px solid #111;padding-bottom:6px;margin-bottom:6px}
.logo{width:46px;height:46px;object-fit:contain}
.htext{flex:1}
.title{font-weight:800;font-size:18px;line-height:1.1}
.sub{font-size:12px;color:#111}
.meta{font-size:12px;margin-top:2px}
.table{width:100%;border-collapse:collapse;margin-top:6px}
.table th,.table td{border:1px solid #000;padding:4px;text-align:left}
.right{text-align:right}
.small{font-size:12px}
.kv{display:flex;justify-content:space-between;gap:10px}
.kv div{padding:2px 0}
.footer{margin-top:8px;text-align:center;font-size:11px;color:#111}
.badge{display:inline-block;border:1px solid #000;padding:1px 8px;border-radius:999px;font-size:11px;float:right}
.topbar{display:none}
@media screen{
  body{background:#f7fafc}
  .sheet{background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.08);border:1px solid #e5e7eb;border-radius:12px}
  .topbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:10px}
  .btn{border:1px solid #cbd5e1;background:#fff;border-radius:10px;padding:6px 12px;font-weight:700;cursor:pointer}
}
</style>
</head>
<body>
<div class="topbar">
  <button class="btn" onclick="window.print()">Print</button>
</div>

<div class="sheet">
  <div class="wrap" id="paper">
    <div class="hdr">
      <img class="logo" src="./assets/logo.png" alt="logo" onerror="this.style.display='none'">
      <div class="htext">
        <div class="title" id="shopTitle">DRUVHI MEDICALS</div>
        <div class="sub" id="shopSub">Saraswathi Nagar, Gopalpur, Hanamkonda · Ph: 08340840340</div>
      </div>
      <div class="badge" id="copyTag">ORIGINAL</div>
    </div>

    <div class="kv small">
      <div><b>Invoice:</b> <span id="invId">—</span></div>
      <div><b>Date:</b> <span id="invDt">—</span></div>
    </div>
    <div class="kv small">
      <div><b>Buyer:</b> <span id="buyer">Walk-in</span></div>
      <div><b>Payment:</b> <span id="pay">—</span></div>
    </div>

    <table class="table" id="lines">
      <thead>
        <tr>
          <th style="width:28px">#</th>
          <th>Product</th>
          <th style="width:70px">Batch</th>
          <th style="width:52px">EXP</th>
          <th style="width:40px">Qty</th>
          <th style="width:60px">MRP</th>
          <th style="width:50px">GST%</th>
          <th style="width:70px">Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="kv right" style="margin-top:6px">
      <div class="small">Subtotal : <b id="subTotal">0.00</b></div>
    </div>
    <div class="kv right small">
      <div>Discount : <b id="disc">0%</b></div>
    </div>
    <div class="kv right" style="font-weight:800">
      <div>Net Total : <span id="netTotal">0.00</span></div>
    </div>

    <div class="small" style="margin-top:6px">
      <b>GST Break-up</b> ·
      5%: ₹<span id="g5">0.00</span> &nbsp; 12%: ₹<span id="g12">0.00</span> &nbsp;
      18%: ₹<span id="g18">0.00</span> &nbsp; 28%: ₹<span id="g28">0.00</span>
    </div>

    <div class="footer">Powered by Onestop AI Services · © 2025 · All Rights Reserved</div>
  </div>
</div>

<script>
/* ---- Load header from optional pharmacy-config ---- */
(async function header(){
  try{
    const r=await fetch('./config/pharmacy-config.json',{cache:'no-store'});
    if(r.ok){
      const c=await r.json();
      document.getElementById('shopTitle').textContent = c.shopName || c.clinicName || 'DRUVHI MEDICALS';
      const sub = [c.address, c.phone, c.gstin].filter(Boolean).join(' · ');
      if(sub) document.getElementById('shopSub').textContent = sub;
    }
  }catch{}
})();

/* ---- Read payload ---- */
function readPayload(){
  // 1) query ?data=
  try{
    const u=new URL(location.href);
    const j=u.searchParams.get('data');
    if(j){ return JSON.parse(decodeURIComponent(j)); }
  }catch{}
  // 2) last_sale_bill
  try{
    const j=localStorage.getItem('last_sale_bill');
    if(j) return JSON.parse(j);
  }catch{}
  // 3) last from pharma_sales_json
  try{
    const arr=JSON.parse(localStorage.getItem('pharma_sales_json')||'[]');
    if(Array.isArray(arr) && arr.length) return arr[arr.length-1];
  }catch{}
  return null;
}

/* ---- Format & fill ---- */
function money(n){ n=+n||0; return n.toFixed(2); }

(function fill(){
  const d = readPayload();
  if(!d){
    document.getElementById('paper').innerHTML = '<div class="small">No sale data found.</div>';
    return;
  }

  // Header/meta
  document.getElementById('invId').textContent = d.id || '—';
  const dt = d.date ? new Date(d.date) : new Date();
  document.getElementById('invDt').textContent = dt.toLocaleDateString()+' '+dt.toLocaleTimeString();
  document.getElementById('buyer').textContent = d.buyer || 'Walk-in';
  document.getElementById('pay').textContent = [d.payMode||'Cash', d.payRef||''].filter(Boolean).join(' · ');

  // Items
  const tbody = document.querySelector('#lines tbody'); tbody.innerHTML='';
  let sub=0;
  (d.items||[]).forEach((r,i)=>{
    const amt = (+r.qty||0) * (+r.mrp||0);
    sub += amt;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.name||''}</td>
      <td>${r.batch||''}</td>
      <td>${r.exp||''}</td>
      <td class="right">${r.qty||0}</td>
      <td class="right">${money(r.mrp||0)}</td>
      <td class="right">${r.gst||0}</td>
      <td class="right">${money(amt)}</td>
    `;
    tbody.appendChild(tr);
  });

  const discPct = +d.discountPct || +d.disc || 0;
  const net = sub * (1 - (discPct/100));

  document.getElementById('subTotal').textContent = money(sub);
  document.getElementById('disc').textContent = (discPct||0) + '%';
  document.getElementById('netTotal').textContent = money(net);

  // GST split
  const gs = {5:0,12:0,18:0,28:0};
  (d.items||[]).forEach(r=>{
    const g = +r.gst||0; const amt=(+r.qty||0)*(+r.mrp||0);
    if(gs[g]!=null) gs[g]+=amt;
  });
  document.getElementById('g5').textContent  = money(gs[5]);
  document.getElementById('g12').textContent = money(gs[12]);
  document.getElementById('g18').textContent = money(gs[18]);
  document.getElementById('g28').textContent = money(gs[28]);
})();

/* ---- Auto print if requested ---- */
(function autoprint(){
  const u=new URL(location.href);
  if(u.searchParams.get('print')==='1'){
    setTimeout(()=>window.print(), 250);
  }
})();
</script>
</body>
</html>