<!doctype html>
<html lang="en">
<head>
  <script src="./config/config.js"></script>
  <script src="./scripts/db.js"></script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales ¬∑ Pharmacy ¬∑ Clinic PWA</title>
  <link rel="manifest" href="./manifest.json"/>
  <link rel="stylesheet" href="./styles.css"/>
<link rel="stylesheet" href="./desktop.css?v=1.0"/>
  <style>
    :root{--bg:linear-gradient(145deg,#eef3f1,#f0eef9,#fff2eb);--card:#fff;--ink:#0f172a;--muted:#475569;--primary:#139a5b;--r:16px;--shadow:0 6px 18px rgba(0,0,0,.08)}
    *{box-sizing:border-box} body{margin:0;font:14px/1.45 system-ui;background:var(--bg);color:var(--ink);} a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:0 10px}
    .topbar{margin-top:12px;border-radius:16px;overflow:hidden;box-shadow:var(--shadow);background:#EEF2FF;border:1px solid #e5e7eb}
    .topbar .row{display:flex;align-items:center;gap:12px;padding:10px 12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:40px}
    .brand .title{font-weight:800;font-size:18px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .links{margin-left:auto;display:flex;gap:8px}
    .btn{background:#fff;border:1px solid #cbd5e1;border-radius:20px;padding:6px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .card{background:var(--card);border-radius:var(--r);padding:14px;box-shadow:var(--shadow);margin-top:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px}
    .input{border:1px solid #cbd5e1;border-radius:8px;padding:8px 10px;width:100%}
    .table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left}
    .table th{background:#f1f5f9}
    .total{font-weight:700;font-size:15px;text-align:right;padding:4px 0}
    .footer{text-align:center;padding:18px 4px 22px;font-size:13px;color:var(--muted);margin:16px 0}
    .hidden{display:none!important}
    @media (max-width:720px){ .table{font-size:12px} }
    @media print{ body{background:#fff;color:#000;margin:0} .wrap{display:block} #printArea{display:none} }
    #printArea{display:none}

    /* 10-col autosuggest grid */
    .suggest-wrap{position:relative}
    .suggest-box{
      position:absolute; top:100%; left:0; right:0;
      background:#fff; border:1px solid #e2e8f0; border-radius:10px;
      box-shadow:0 12px 28px rgba(0,0,0,.12);
      margin-top:6px; max-height:260px; overflow:auto; z-index:1000; padding:8px;
    }
    .suggest-grid{display:grid; grid-template-columns:repeat(10, minmax(90px, 1fr)); gap:6px; min-width:100%;}
    .sug-item{border:1px solid #e5e7eb; border-radius:8px; padding:6px 8px; font:12px system-ui; background:#F8FAFC; cursor:pointer; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .sug-item:hover{background:#EEF2FF;border-color:#c7d2fe}

    /* Blank rows for neat print */
    .blank-row td{height:24px}
  </style>
  <script src="/scripts/app-wiring.js"></script>
</head>
<body>
<div class="wrap">

  <div class="topbar">
    <div class="row">
      <div class="brand">
        <img class="logo" src="./assets/logo.png" alt="logo">
        <div>
          <div class="title">Sales (POS)</div>
          <div class="sub">FEFO ¬∑ Retail Bill A5 ¬∑ barcode-ready</div>
        </div>
      </div>
      <div class="links">
        <a class="btn" href="./pharmacy.html">DRUVHI MEDICALS</a>
        <a class="btn" href="./index.html">Home</a>
      </div>
    </div>
  </div>

  <!-- No banner -->

  <div class="card" style="background:#D6E5DD">
    <h3 style="margin:0 0 6px">New Sale</h3>
    <div class="row">
      <div style="flex:1">
        <label>Patient / Buyer Name</label>
        <input id="buyer" class="input" placeholder="Walk-in / PID">
      </div>

      <div style="flex:1" class="suggest-wrap">
        <label>Search Product (name or barcode)</label>
        <input id="pname" class="input" oninput="suggest()" list="plist" placeholder="Start typing or scan‚Ä¶">
        <div id="pgrid" class="suggest-box hidden">
          <div class="suggest-grid" id="pgridBody"></div>
        </div>
      </div>

      <datalist id="plist"></datalist>

      <div style="flex:0 0 110px">
        <label>Qty</label>
        <input id="pqty" class="input" type="number" min="1" value="1">
      </div>
      <div style="flex:1 1 260px">
        <label>Payment</label>
        <div class="row">
          <select id="payMode" class="input" style="flex:1">
            <option>Cash</option><option>UPI</option><option>Card</option><option>Wallet</option>
          </select>
          <input id="payRef" class="input" style="flex:1" placeholder="Ref / Txn (optional)">
        </div>
      </div>
      <div style="flex:0 0 260px;align-self:end" class="row">
        <button class="btn primary" onclick="addItem()">Add Item</button>
        <button class="btn" data-scan data-scan-target="#pname" id="scanSales">Scan</button>
      </div>
    </div>
  </div>

  <div class="card" style="background:#FFF9F3">
    <table class="table" id="saleTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Product</th>
          <th>HSN</th>
          <th>Pack</th>
          <th>Batch</th>
          <th>EXP</th>
          <th>Qty</th>
          <th>MRP/Each</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="8" class="total">Subtotal</td><td id="subTotal">0.00</td></tr>
        <tr><td colspan="8" class="total">Discount (%)</td><td><input id="disc" type="number" style="width:70px;text-align:right" value="0" oninput="recalc()"></td></tr>

        <!-- GST summary -->
        <tr>
          <td colspan="8" class="total">GST % (inclusive)</td>
          <td>
            <select id="gstRate" class="input" style="width:90px" onchange="recalc()">
              <option value="0">0</option>
              <option value="5">5</option>
              <option value="12" selected>12</option>
              <option value="18">18</option>
              <option value="28">28</option>
            </select>
          </td>
        </tr>
        <tr><td colspan="8" class="total">Taxable Value</td><td id="taxableVal">0.00</td></tr>
        <tr><td colspan="8" class="total">CGST</td><td id="cgstVal">0.00</td></tr>
        <tr><td colspan="8" class="total">SGST</td><td id="sgstVal">0.00</td></tr>
        <tr><td colspan="8" class="total">Net Total</td><td id="netTotal">0.00</td></tr>
      </tfoot>
    </table>
    <div class="row" style="justify-content:flex-end;margin-top:10px;gap:8px">
      <button class="btn" onclick="clearAll()">Clear</button>
      <button class="btn" id="btnPrint" onclick="printBill()">üñ®Ô∏è Print A5 Bill</button>
      <button class="btn primary" id="btnSave" onclick="saveInvoice()">üíæ Save Invoice</button>
    </div>
  </div>

  <div class="footer">¬© 2025 <strong>Powered by Onestop AI Services</strong> ¬∑ All Rights Reserved</div>
</div>

<div id="printArea"></div>

<script>
let STOCK=[], SALE=[];
function loadStock(){ try{STOCK=JSON.parse(localStorage.getItem('pharma_stock_json')||'[]')||[]}catch{STOCK=[]} }
loadStock();

function uniqNames(list){
  const seen=new Set(); const out=[];
  for(const s of list){ const n=(s.name||'').trim(); if(!n) continue;
    const key=n.toLowerCase(); if(seen.has(key)) continue; seen.add(key); out.push(n);
  }
  return out;
}

function suggest(){
  const val=document.getElementById('pname').value.toLowerCase();
  const d=document.getElementById('plist'); d.innerHTML='';
  const grid=document.getElementById('pgrid');
  const gridBody=document.getElementById('pgridBody');
  gridBody.innerHTML='';

  if(!val){ grid.classList.add('hidden'); return; }

  const matches = STOCK.filter(s=> (s.name||'').toLowerCase().includes(val));
  const names = uniqNames(matches).sort();

  names.slice(0,10).forEach(n=>{
    const o=document.createElement('option'); o.value=n; d.appendChild(o);
  });

  names.slice(0,200).forEach(n=>{
    const b=document.createElement('div');
    b.className='sug-item';
    b.textContent=n; b.title=n;
    b.onclick=()=>{
      document.getElementById('pname').value=n;
      grid.classList.add('hidden');
      document.getElementById('pname').focus();
    };
    gridBody.appendChild(b);
  });

  grid.classList.toggle('hidden', gridBody.children.length===0);
}

function toExp(mmYY){ const [m,y]=String(mmYY||'').split('/').map(n=>parseInt(n,10)); return new Date(2000+(y||0),((m||1)-1),1); }
function eqi(a,b){return String(a||'').toLowerCase()===String(b||'').toLowerCase();}
function persistStock(){ localStorage.setItem('pharma_stock_json',JSON.stringify(STOCK)); }
function q(sel){return document.querySelector(sel)} function g(id){return document.getElementById(id).value} function s(id,v){document.getElementById(id).value=v}
function money(n){ n=+n||0; return n.toFixed(2); }

function addFromPool(pool, qty){
  let need=qty; const picks=[];
  for(const st of pool.sort((a,b)=>toExp(a.exp)-toExp(b.exp))){
    if(need<=0) break; if((st.qty||0)<=0) continue;
    const take=Math.min(st.qty,need); st.qty-=take; need-=take;
    picks.push({
      name:st.name,
      hsn:st.hsn || '',          // <-- HSN carried from stock
      pack:st.pack || st.unit || '',
      batch:st.batch,
      exp:st.exp,
      qty:take,
      mrp:+st.mrp
    });
  }
  if(need>0){ alert('Insufficient stock'); return; }
  SALE.push(...picks); persistStock(); render();
}

function addItem(){
  const name=g('pname').trim(); const qty=+g('pqty')||0; if(!name||!qty)return;
  const pool = STOCK.filter(s=>eqi(s.name,name));
  if(!pool.length){ alert('Not found'); return; }
  addFromPool(pool, qty);
  s('pname',''); s('pqty','1');
  document.getElementById('pgrid').classList.add('hidden');
}

function render(){
  const tb=q('#saleTable tbody'); tb.innerHTML=''; let sub=0;
  SALE.forEach((r,i)=>{ const amt=r.qty*r.mrp; sub+=amt;
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td>${i+1}</td>
        <td>${r.name||''}</td>
        <td>${r.hsn||''}</td>
        <td>${r.pack||''}</td>
        <td>${r.batch||''}</td>
        <td>${r.exp||''}</td>
        <td>${r.qty}</td>
        <td>${money(r.mrp)}</td>
        <td>${money(amt)}</td>
      </tr>`);
  });

  // Ensure 10 blank rows before totals
  const blanks = Math.max(0, 10 - SALE.length);
  for(let i=0;i<blanks;i++){
    tb.insertAdjacentHTML('beforeend', `
      <tr class="blank-row">
        <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
      </tr>`);
  }

  q('#subTotal').textContent=sub.toFixed(2);
  recalc();
}

function recalc(){
  const sub=+q('#subTotal').textContent||0;
  const d=+g('disc')||0;
  const afterDisc = sub*(1-d/100);
  q('#netTotal').textContent=afterDisc.toFixed(2);

  // GST breakdown (assumes MRP is GST-inclusive)
  const rate = +(document.getElementById('gstRate')?.value || 0);
  if(rate>0){
    const taxable = afterDisc * (100/(100+rate));
    const gstAmt  = afterDisc - taxable;
    const half = gstAmt/2;
    q('#taxableVal').textContent = taxable.toFixed(2);
    q('#cgstVal').textContent = half.toFixed(2);
    q('#sgstVal').textContent = half.toFixed(2);
  }else{
    q('#taxableVal').textContent = afterDisc.toFixed(2);
    q('#cgstVal').textContent = '0.00';
    q('#sgstVal').textContent = '0.00';
  }
}

function saveInvoice(){
  if(!SALE.length)return alert("No items added!");
  const buyer=g('buyer')||'Walk-in';
  const now=new Date();
  const id='DM'+now.getTime().toString().slice(-6);
  const total=+q('#netTotal').textContent||0;

  // items already include HSN
  const bill={ id,buyer,total, items:SALE, date:now.toISOString(), payMode:g('payMode'), payRef:g('payRef') };
  let arr=[]; try{arr=JSON.parse(localStorage.getItem('pharma_sales_json')||'[]')}catch{}
  arr.push(bill); localStorage.setItem('pharma_sales_json',JSON.stringify(arr));
  localStorage.setItem('last_sale_bill', JSON.stringify(bill));
  alert("‚úÖ Invoice saved successfully!");
}

function printBill(){
  try{
    const latest = JSON.parse(localStorage.getItem('last_sale_bill')||'null');
    if(!latest && !SALE.length){ alert('Nothing to print'); return; }
    const data = latest || {
      id:'TMP'+Date.now().toString().slice(-6),
      buyer:g('buyer')||'Walk-in',
      items: SALE.slice(), // contains HSN per line
      date:new Date().toISOString(),
      payMode:g('payMode'), payRef:g('payRef'),
      total:+q('#netTotal').textContent||0
    };
    localStorage.setItem('last_sale_bill', JSON.stringify(data));
    window.open('./print/print-sales.html?print=1','_blank');
  }catch{ window.open('./print/print-sales.html','_blank'); }
}

function clearAll(){ SALE=[]; render(); }

/* Close grid on outside click / ESC */
document.addEventListener('click', (e)=>{
  const box=document.getElementById('pgrid');
  if(!box) return;
  const wrap = box.closest('.suggest-wrap');
  if(!wrap.contains(e.target)) box.classList.add('hidden');
});
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){ const box=document.getElementById('pgrid'); if(box) box.classList.add('hidden'); }
});

/* Rx Receiver Dock (unchanged) */
(function(){
  const QKEY='pharma_rx_queue';
  const dock=document.createElement('div');
  dock.style.cssText='position:fixed;right:14px;bottom:14px;z-index:9999';
  dock.innerHTML='<button id="rxDock" style="padding:8px 12px;border-radius:20px;background:#111827;color:#fff;border:none;font-weight:700">Pending Rx</button><div id="rxPanel" style="display:none;position:fixed;right:14px;bottom:56px;width:320px;background:#fff;border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);padding:10px"></div>';
  document.body.appendChild(dock);
  const box=document.getElementById('rxPanel');
  function renderDock(){
    let arr=[]; try{arr=JSON.parse(localStorage.getItem(QKEY)||'[]');}catch{}
    box.innerHTML = arr.length ? '' : '<div style="font:12px system-ui;color:#475569">No pending prescriptions</div>';
    arr.slice().reverse().forEach((o,ix)=>{
      const idx=arr.length-1-ix;
      const lines=(o.items||[]).map(x=>`${x.name} ‚Äî ${x.dose||''} ${x.freq||''} √ó${x.qty||1}`).join('<br>');
      const d=document.createElement('div');
      d.style.cssText='border:1px solid #e5e7eb;border-radius:10px;padding:8px;margin:6px 0;background:#F8FAFC;font:13px system-ui';
      d.innerHTML=`<b>${o.pid||''} ‚Äî ${o.name||''}</b>
        <div style="font-size:12px;color:#475569;margin:4px 0">${lines||'(no items?)'}</div>
        <div style="display:flex;gap:6px">
          <button data-act="add" data-idx="${idx}">Add to Cart</button>
          <button data-act="done" data-idx="${idx}">Mark Done</button>
        </div>`;
      box.appendChild(d);
    });
  }
  document.getElementById('rxDock').onclick=()=>{ box.style.display=box.style.display==='block'?'none':'block'; renderDock(); };
  box.addEventListener('click',e=>{
    const b=e.target.closest('button'); if(!b) return;
    let arr=[]; try{arr=JSON.parse(localStorage.getItem(QKEY)||'[]');}catch{}
    const idx=+b.dataset.idx; const order=arr[idx]; if(!order) return;
    if(b.dataset.act==='add'){
      (order.items||[]).forEach(it=>{
        const pool = STOCK.filter(s=>eqi(s.name,it.name));
        if(pool.length){ addFromPool(pool, it.qty||1); }
      });
      render(); return;
    }
    if(b.dataset.act==='done'){ arr.splice(idx,1); localStorage.setItem(QKEY,JSON.stringify(arr)); renderDock(); }
  });
})();
</script>

<script src="/scripts/scanner.js?v=1.0"></script>
<script src="/scripts/shortcuts.js?v=1.0"></script>
</body>
</html>